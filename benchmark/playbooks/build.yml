- name: Build benchmark container
  hosts: "{{ groups['machines'][0] }}"

  tasks:
    - name: Copy source code to remote machine
      synchronize:
        src: "{{ playbook_dir }}/../../../libp2p-dog"
        dest: /home/{{ ansible_ssh_user }}
        mode: push
        delete: true

    - name: Build container
      shell: |
        docker build \
          -t dog-benchmark:latest \
          -f /home/{{ ansible_ssh_user }}/libp2p-dog/benchmark/Dockerfile \
          /home/{{ ansible_ssh_user }}/libp2p-dog
        docker save dog-benchmark:latest > ~/container.tar

    - name: Copy container to local machine
      synchronize:
        src: container.tar
        dest: /tmp
        mode: pull
        delete: true

- name: Upload benchmark container
  hosts: all

  tasks:
    - name: Copy container to remote machines
      synchronize:
        src: /tmp/container.tar
        dest: /tmp
        mode: push
        delete: true

    - name: Load container
      shell: |
        docker load < /tmp/container.tar
